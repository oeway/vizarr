var x=Object.defineProperty,A=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var y=Object.getOwnPropertySymbols;var k=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var m=(n,r,e)=>r in n?x(n,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[r]=e,l=(n,r)=>{for(var e in r||(r={}))k.call(r,e)&&m(n,e,r[e]);if(y)for(var e of y(r))I.call(r,e)&&m(n,e,r[e]);return n},p=(n,r)=>A(n,$(r));var g=(n,r,e)=>(m(n,typeof r!="symbol"?r+"":r,e),e);function w(n,r=/{{(.*?)}}/){let e=r.exec(n);const t=[];let s;for(;e;)s=e.index,s!==0&&(t.push({match:!1,str:n.substring(0,s)}),n=n.slice(s)),t.push({match:!0,str:e[0]}),n=n.slice(e[0].length),e=r.exec(n);return n&&t.push({match:!1,str:n}),t}function O(n){const r=n.match(/(?<fname>[A-Z_][A-Z_1-9]*)\((?<args>[^)]+)\)/i);if(!(r==null?void 0:r.groups))return;const{fname:e,args:t}=r.groups,s=Object.fromEntries(t.split(",").map(f=>{var o,c;const{key:u,num:a,str:i}=(c=(o=f.match(/(?<key>[a-z_0-9]*)\s*=\s*((?<num>[0-9.]+)|('|")(?<str>.*)('|"))/i))==null?void 0:o.groups)!=null?c:{};if(!u||!(a||i))throw Error(`Failed to match fn kwarg: ${f}`);return[u,a?Number(a):i]}));return{fname:e,ctx:s}}const E="abcdefghijklmnopqrstuvwxyz",j="01234569789",S="()*/+-",C=" ",z=new Set(E+E.toUpperCase()+j+S+C);function F(n){for(let r=0;r<n.length;r++)if(!z.has(n.charAt(r)))return;return w(n,/[A-Za-z_][A-Za-z0-9_]*/gi)}function R(n,r){return w(n).map(t=>{if(!t.match)return t.str;let s=t.str.split(/{{|}}/).filter(Boolean)[0].trim();if(s in r)return r[s];const f=O(s);if(f){const{fname:a,ctx:i}=f,o=r[a];if(typeof o=="function")return o(i);throw Error(`Cannot find function named ${a} in rendering context.`)}const u=F(s);if(u){const a=u.map(i=>{if(!i.match)return i.str;const o=r[i.str];if(o==null)throw Error(`Cannot find number named ${i.str} in rendering context.`);if(typeof o!="number")throw Error(`The provided value for ${i.str} must be a number.`);return o});return Function('"use strict";return ('+a.join("")+")")()}throw new Error(`Unable to match ${t.str}`)}).join("")}function M(n,r=R){return"version"in n?U(n,r):N(n)}function N(n){return new Map(Object.entries(n))}function U(n,r){var f,u,a,i;const e={};for(const[o,c]of Object.entries((f=n.templates)!=null?f:{}))c.includes("{{")?e[o]=h=>r(c,h):e[o]=c;const t=(o,c)=>r(o,l(l({},e),c)),s=new Map;for(const[o,c]of Object.entries((u=n.refs)!=null?u:{}))if(typeof c=="string")s.set(o,c);else{const h=((a=c[0])==null?void 0:a.includes("{{"))?t(c[0]):c[0];s.set(o,c.length===1?[h]:[h,c[1],c[2]])}for(const o of(i=n.gen)!=null?i:[])for(const c of Z(o.dimensions)){const h=t(o.key,c),d=t(o.url,c);if(o.offset&&o.length){const v=t(o.offset,c),_=t(o.length,c);s.set(h,[d,parseInt(v),parseInt(_)])}else s.set(h,[d])}return s}function*Z(n){const r=Object.keys(n),e=Object.values(n).map(t=>Array.isArray(t)?t:[...J(t)]);for(const t of B(...e))yield Object.fromEntries(r.map((s,f)=>[s,t[f]]))}function*B(...n){if(n.length===0)return;const r=n.map(t=>t[Symbol.iterator]()),e=r.map(t=>t.next());if(e.some(t=>t.done))throw new Error("Input contains an empty iterator.");for(let t=0;;){if(e[t].done){if(r[t]=n[t][Symbol.iterator](),e[t]=r[t].next(),++t>=r.length)return}else yield e.map(({value:s})=>s),t=0;e[t]=r[t].next()}}function*J({stop:n,start:r=0,step:e=1}){for(let t=r;t<n;t+=e)yield t}class K extends Error{constructor(r){super(r);g(this,"__zarr__","KeyError");this.name="KeyError"}}class b{constructor(r,e={}){this.ref=r,this.target=e.target}static fromJSON(r,e={}){const t=typeof r=="string"?JSON.parse(r):r,s=M(t,e.renderString);return new b(s,e)}_url(r){const[e,t]=r.split("://");if(e==="https"||e==="http")return r;if(e==="gc")return`https://storage.googleapis.com/${t}`;if(e==="s3")return`https://s3.amazonaws.com/${t}`;throw Error("Protocol not supported, got: "+JSON.stringify(e))}_fetch({url:r,offset:e,size:t},s){return e!==void 0&&t!==void 0&&(s=p(l({},s),{headers:p(l({},s.headers),{Range:`bytes=${e}-${e+t-1}`})})),fetch(this._url(r),s)}async getItem(r,e={}){const t=this.ref.get(r);if(!t)throw new K(r);if(typeof t=="string")return t.startsWith("base64:")?q(t.slice(7)).buffer:P.encode(t).buffer;const[s,f,u]=t,a=s!=null?s:this.target;if(!a)throw Error(`No url for key ${r}, and no target url provided.`);const i=await this._fetch({url:a,offset:f,size:u},e);if(i.status===200||i.status===206)return i.arrayBuffer();throw new Error(`Request unsuccessful for key ${r}. Response status: ${i.status}.`)}async containsItem(r){return this.ref.has(r)}async keys(){return[...this.ref.keys()]}setItem(r,e){throw Error("FileReferenceStore.setItem is not implemented.")}deleteItem(r){throw Error("FileReferenceStore.deleteItem is not implemented.")}}const q=(()=>{for(var n=new Uint8Array(128),r=0;r<64;r++)n[r<26?r+65:r<52?r+71:r<62?r-4:r*4-205]=r;return e=>{for(var t=e.length,s=new Uint8Array((t-(e[t-1]=="=")-(e[t-2]=="="))*3/4|0),f=0,u=0;f<t;){var a=n[e.charCodeAt(f++)],i=n[e.charCodeAt(f++)],o=n[e.charCodeAt(f++)],c=n[e.charCodeAt(f++)];s[u++]=a<<2|i>>4,s[u++]=i<<4|o>>2,s[u++]=o<<6|c}return s}})(),P=new TextEncoder;export{b as ReferenceStore,M as parse};
